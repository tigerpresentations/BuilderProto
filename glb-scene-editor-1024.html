<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D GLB Scene Editor - Canvas-to-Texture Pipeline</title>
    <style>
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; overflow: hidden; background: #1a1a1a; color: #fff; }
        canvas#three-canvas { position: fixed; top: 0; left: 0; z-index: 1; }
        
        /* Controls Panel - Three.js-style */
        #controls { position: fixed; top: 10px; left: 10px; background: rgba(20, 20, 20, 0.95); border: 1px solid #333; border-radius: 6px; padding: 12px; width: 280px; max-height: calc(100vh - 40px); overflow-y: auto; z-index: 100; font-size: 12px; backdrop-filter: blur(10px); }
        
        .collapsible-panel { margin-bottom: 12px; border: 1px solid #444; border-radius: 4px; background: rgba(40, 40, 40, 0.6); }
        .panel-header { background: #333; padding: 8px 12px; cursor: pointer; user-select: none; display: flex; justify-content: space-between; align-items: center; border-radius: 3px 3px 0 0; }
        .panel-header:hover { background: #444; }
        .panel-toggle { font-size: 10px; color: #aaa; }
        .panel-content { padding: 10px; }
        .collapsible-panel.collapsed .panel-content { display: none; }
        
        .control-group { margin-bottom: 12px; }
        .control-group label { display: block; margin-bottom: 4px; color: #ccc; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; }
        .control-group input, .control-group select { width: 100%; padding: 6px 8px; background: #222; border: 1px solid #555; border-radius: 3px; color: #fff; font-size: 11px; }
        .control-group input[type="range"] { padding: 0; height: 20px; }
        .control-group input:focus { outline: none; border-color: #0084ff; box-shadow: 0 0 0 2px rgba(0, 132, 255, 0.2); }
        
        button { background: #333; color: #fff; border: 1px solid #555; padding: 8px 12px; border-radius: 3px; cursor: pointer; font-size: 11px; }
        button:hover { background: #444; }
        button:active { background: #222; }
        
        /* Range Slider Styling */
        input[type="range"] { -webkit-appearance: none; appearance: none; height: 4px; background: #444; outline: none; border-radius: 2px; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 16px; height: 16px; background: #0084ff; cursor: pointer; border-radius: 50%; }
        input[type="range"]::-moz-range-thumb { width: 16px; height: 16px; background: #0084ff; cursor: pointer; border-radius: 50%; border: none; }
        
        .slider-value { display: inline-block; min-width: 40px; text-align: right; color: #0084ff; font-weight: 500; }
        
        /* Drop Zone */
        #drop-zone { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 300px; height: 200px; border: 2px dashed #555; border-radius: 8px; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 50; background: rgba(30, 30, 30, 0.9); transition: all 0.3s ease; }
        #drop-zone.dragging { border-color: #0084ff; background: rgba(0, 132, 255, 0.1); }
        #drop-zone.hidden { display: none; }
        #drop-zone p { margin: 0; text-align: center; color: #aaa; }
        
        /* Canvas Editor Panel */
        #canvas-editor { position: fixed; top: 10px; right: 10px; background: rgba(20, 20, 20, 0.95); border: 1px solid #333; border-radius: 6px; width: 450px; max-height: calc(100vh - 40px); overflow-y: auto; z-index: 100; backdrop-filter: blur(10px); transition: width 0.3s ease; }
        #canvas-editor.panel-collapsed { width: auto; max-width: 200px; }
        
        /* Canvas Container */
        .canvas-container { padding: 12px; display: flex; flex-direction: column; align-items: center; }
        #display-canvas { border: 1px solid #555; border-radius: 4px; max-width: 100%; height: auto; background: white; cursor: crosshair; }
        
        /* Mode Selector */
        .mode-selector { display: flex; gap: 6px; margin: 12px 0; }
        .mode-btn { padding: 6px 12px; font-size: 11px; border-radius: 3px; background: #333; color: #ccc; border: 1px solid #555; cursor: pointer; }
        .mode-btn.active { background: #0084ff; color: white; border-color: #0084ff; }
        .mode-btn:hover:not(.active) { background: #444; }
        
        /* Tool Sections */
        #draw-tools { display: none; }
        #image-tools { margin-top: 12px; }
        
        /* Color Modal */
        #colorModal { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0, 0, 0, 0.7); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: #1a1a1a; padding: 24px; border-radius: 8px; width: 400px; max-width: 90vw; border: 1px solid #333; }
        .color-preview { width: 60px; height: 60px; border: 2px solid #555; border-radius: 6px; margin: 12px 0; }
        .recent-colors { display: flex; gap: 8px; margin: 12px 0; }
        .swatch-preview { width: 24px; height: 24px; border: 1px solid #555; border-radius: 4px; cursor: pointer; }
        .swatch-preview:hover { border-color: #0084ff; }
        
        /* Quick Swatches */
        #quickSwatches { display: flex; gap: 4px; align-items: center; }
        
        /* UI Resizer */
        .ui-resizer { position: absolute; background: #333; opacity: 0.3; transition: opacity 0.2s; }
        .ui-resizer:hover, .ui-resizer.resizing { opacity: 0.8; }
        .ui-resizer.vertical { top: 0; right: -3px; width: 6px; height: 100%; cursor: ew-resize; }
        .ui-resizer.horizontal { bottom: -3px; left: 0; width: 100%; height: 6px; cursor: ns-resize; }
        
        /* Performance Info */
        .performance-info { position: fixed; bottom: 10px; right: 10px; background: rgba(20, 20, 20, 0.9); padding: 8px 12px; border-radius: 4px; font-size: 10px; color: #aaa; z-index: 50; }
    </style>
</head>
<body>
    <!-- Drop Zone -->
    <div id="drop-zone">
        <p>Drop GLB file here</p>
        <p style="font-size: 12px; color: #666;">Or use the file input below</p>
    </div>
    
    <!-- Controls Panel -->
    <div id="controls">
        <div class="collapsible-panel main-panel">
            <div class="panel-header" data-panel="scene-controls" data-target="controls">
                <span>3D Scene Controls</span>
                <span class="panel-toggle">▼</span>
            </div>
            <div class="panel-content">
                <!-- Model Controls -->
                <div id="model-controls" style="display: none;">
                    <div class="control-group">
                        <label>Position X</label>
                        <input type="range" id="pos-x" min="-10" max="10" step="0.1" value="0">
                        <span class="slider-value" id="pos-x-val">0.0</span>
                    </div>
                    <div class="control-group">
                        <label>Position Z</label>
                        <input type="range" id="pos-z" min="-10" max="10" step="0.1" value="0">
                        <span class="slider-value" id="pos-z-val">0.0</span>
                    </div>
                    <div class="control-group">
                        <label>Scale</label>
                        <input type="range" id="scale" min="0.1" max="3" step="0.1" value="1">
                        <span class="slider-value" id="scale-val">1.0</span>
                    </div>
                    <div class="control-group">
                        <label>Rotation Y</label>
                        <input type="range" id="rot-y" min="0" max="360" step="1" value="0">
                        <span class="slider-value" id="rot-y-val">0°</span>
                    </div>
                    <div class="control-group">
                        <label>
                            <input type="checkbox" id="backlight-toggle"> Backlight Effect
                        </label>
                    </div>
                    <button id="clear-model-btn" style="display: none;">Clear Model</button>
                </div>
                
                <!-- Scene Controls -->
                <div class="control-group">
                    <label>Background Color</label>
                    <input type="color" id="bg-color" value="#cccccc">
                </div>
                
                <!-- Canvas Editor Toggle -->
                <div class="control-group">
                    <button id="toggle-canvas-btn">Toggle Canvas Editor</button>
                </div>
                
                <!-- Developer Tools -->
                <div class="control-group">
                    <button id="lighting-dev-btn">Lighting Console</button>
                </div>
            </div>
        </div>
        
        <!-- Authentication -->
        <div class="collapsible-panel">
            <div class="panel-header" data-panel="auth-controls">
                <span>User Authentication</span>
                <span class="panel-toggle">▼</span>
            </div>
            <div class="panel-content">
                <div id="authSection">
                    <form id="loginForm" style="display: block;">
                        <div class="control-group">
                            <label>Email</label>
                            <input type="email" id="loginEmail" placeholder="your@email.com" required>
                        </div>
                        <div class="control-group">
                            <label>Password</label>
                            <input type="password" id="loginPassword" placeholder="Password" required>
                        </div>
                        <button type="submit" style="width: 100%; margin-top: 8px;">Login</button>
                    </form>
                    <div id="userInfo" style="display: none;">
                        <div class="control-group">
                            <p style="font-size: 11px; color: #28a745; margin: 0;">
                                ✓ Logged in as: <span id="userEmail"></span>
                            </p>
                            <button id="logoutBtn" style="width: 100%; margin-top: 8px; background: #dc3545; border-color: #dc3545;">Logout</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Status -->
        <div class="control-group">
            <div id="status" style="font-size: 10px; color: #666;">Drop a GLB file to begin</div>
            <div id="performance-info" style="margin-top: 4px; font-size: 10px; color: #666;">Performance: 60 FPS</div>
            <div id="quality-info" style="margin-top: 4px; font-size: 10px; color: #666;">Resolution: 1024x1024</div>
        </div>
    </div>
    
    <!-- Canvas Editor Panel -->
    <div id="canvas-editor">
        <div class="ui-resizer vertical" data-panel="canvas-editor"></div>
        
        <div class="collapsible-panel main-panel">
            <div class="panel-header" data-panel="canvas-editor">
                <span>Canvas Texture Editor</span>
                <span class="panel-toggle">▼</span>
            </div>
            <div class="panel-content">
                <!-- Canvas Container - UV-based single canvas system -->
                <div class="canvas-container">
                    <canvas id="display-canvas" width="512" height="512"></canvas>
                    <!-- texture-canvas removed - now handled by UVTextureEditor -->
                </div>
                
                <!-- Mode Selector -->
                <div class="mode-selector">
                    <button id="draw-mode-btn" class="mode-btn">Draw</button>
                    <button id="select-mode-btn" class="mode-btn active">Select</button>
                </div>
                
                <!-- Draw Tools -->
                <div id="draw-tools">
                    <div class="control-group">
                        <label>Brush Color</label>
                        <input type="color" id="brush-color" value="#ff0000">
                    </div>
                </div>
                
                <!-- Image Tools -->
                <div id="image-tools">
                    <div class="control-group">
                        <label>Upload Image</label>
                        <input type="file" id="image-upload" accept="image/*">
                    </div>
                    
                    <div class="control-group">
                        <button onclick="showColorSquareDialog()">Add Color Square</button>
                        <div id="quickSwatches" style="display: flex; gap: 4px; margin-top: 8px;"></div>
                    </div>
                    
                    <div class="control-group">
                        <button id="clear-canvas-btn">Clear Canvas</button>
                        <button id="hide-canvas-btn">Hide Panel</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Color Modal -->
    <div id="colorModal">
        <div class="modal-content">
            <h3>Create Color Square</h3>
            <div class="control-group">
                <label>Color</label>
                <input type="color" id="modalColorPicker" value="#ff0000">
            </div>
            <div class="control-group">
                <label>Hex</label>
                <input type="text" id="hexInput" value="#ff0000">
            </div>
            <div style="display: flex; gap: 12px;">
                <div class="control-group" style="flex: 1;">
                    <label>Red</label>
                    <input type="number" id="redInput" min="0" max="255" value="255">
                </div>
                <div class="control-group" style="flex: 1;">
                    <label>Green</label>
                    <input type="number" id="greenInput" min="0" max="255" value="0">
                </div>
                <div class="control-group" style="flex: 1;">
                    <label>Blue</label>
                    <input type="number" id="blueInput" min="0" max="255" value="0">
                </div>
            </div>
            <div class="control-group">
                <label>Opacity</label>
                <input type="range" id="opacitySlider" min="0" max="1" step="0.1" value="1">
                <span id="opacityValue">100%</span>
            </div>
            <div class="color-preview" id="colorPreview"></div>
            
            <div class="control-group">
                <label>Recent Colors</label>
                <div class="recent-colors" id="recentColors"></div>
            </div>
            
            <div style="display: flex; gap: 12px; margin-top: 20px;">
                <button onclick="insertColorSquare()" style="flex: 1;">Add Square</button>
                <button onclick="closeColorModal()" style="flex: 1;">Cancel</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    <script src="env.js"></script>
    <script src="auth.js"></script>
    <!-- Simple coordinate system - no scaling complexity -->
    <script src="simple-coordinate-system.js"></script>
    <script src="scene-manager.js"></script>
    <script src="model-loader.js"></script>
    <script src="canvas-editor.js"></script>
    <!-- Simple layer system - works entirely in 512x512 space -->
    <script src="simple-layer-manager.js"></script>
    <script src="simple-interactive-editor.js"></script>
    <script src="ui-controls.js"></script>
    <script src="main.js"></script>
    <script>
        // All initialization is now handled by main.js
    </script>
</body>
</html>